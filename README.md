grape-tester
============
Это скрипт для тестирования связки  elliptics + cocaine + grape.

Общая схема работы
==================
Есть одна главная машина и несколько машин для нод с elliptics'ом. Скрипт устанавливает с помощью
apt некоторый список пакетов на главную машину и на ноды с elliptics'ом. Для главной машины и для нод
списки пакетов отдельные. Затем скрипт запускает на нодах еллиптикс. На первой в списке ноде он
собирает и аплоадит в cocaine тестовое приложение. Далее скрипт тестирует
правильность работы тестового приложения, завершает демоны elliptics'а на нодах и загружает в
текущую директорию файлы со всех нод.

Файлы
=====
* main_tester.py - самый главный скрипт. Он работает на главной машине и запускать надо именно его. Выполните main_tester.py --help для справки.
* node_tester.py - скрипт, который работает на нодах. Трогать его не стоит.
* main_config.py - конфиг для главной машины.
* node_config.py - конфиг для нод с elliptics'ом. Да, оба конфига - это модули на питоне.
* ssh_operations.py - обертки над ssh.
* common/ - всякие служебные модули, которые используют и main_tester.py, и node_tester.py.
* node_files/ - конфигурация нод. Скрипт найдет все файлы с расширением ".tmpl", обработает их
препроцессором и уберет расширение .tmpl. Затем скрипт скопирует полученную папку на ноды под именем files/.

Шаблоны можно и нужно редактировать, если вам нужна какая-то другая конфигурация.
Текст типа <{code}> - это код на питоне, вместо которого в реальный конфиг будет подставлен результат выполнения этого кода.
В таком коде доступны модули main_config и node_config (например, можно будет написать <{node_config.working_dir}>)
и переменная node, в которой находится адрес ноды, на которую отправится конфиг.

Использование
=============
Скрипт выполняет некоторые команды на серверах от суперпользователя. Поэтому у пользователя, под
которым скрипт работает на нодах, должны быть права на использование sudo без пароля.

Так же у скрипта должен быть доступ на ноды по ssh без пароля. Поэтому на нодах нужно настроить
аутентификацию по ключу. Файл с приватным ключом можно указать скрипту через параметр -k, в конфиге
или просто ничего не делать, если ssh его и так найдет (если это ~/.ssh/id_rsa или он прописан в ~/.ssh/config и т.п.).

Адреса нод с элептиксом нужно вписать в main_config.py. Запускать main_tester.py можно от любого
пользователя, а пользователя на нодах нужно вписать в main_config.py.

Теперь можно запустить main_tester.py и потестировать grape.

После того, как скрипт отработает, в текущей директории появится директория nodes/ и файл tester.log.
В tester.log будет лог работы main_tester.py (просто продублированный вывод скрипта). В папке nodes/
будут папочки 0/, 1/ и т.д. - это папочки с файлами с нод. Имя каждой папочки - это позиция ноды в списке в конфиге.
В каждой такой папке можно найти файлы, которые были отправленны на ноду (nodes/0/to_deploy/), файлы, которые были загруженны с ноды (nodes/0/files/)
и лог работы скрипта на ноде (nodes/0/tester.log).  Отправленные и загруженные файлы сильно дублируются, но
в загруженных есть всякие логи и другие полезные для отладки файлы.

При запуске скрипт предварительно очистит папочку nodes/ и рабочие директории скрипта на нодах.
Так что сохраните логи, если они вам нужны!

ВНИМАНИЕ: во время работы скрипта лучше не нажимать Ctrl+C, потому что с этим все сложно.

Конфигурация
============
Назначение всех параметров прокомментированно в самих конфигах или очевидно.

В папке node_files должна целиком находиться конфигурация кокаина и эллиптикса, в том числе должны быть созданы все папки.
Можно делать шаблоны (см. выше).

В node_config.py нужно указать пути к некоторым файлам, которые нужны для работы node_tester.py.
Не забудьте сделать это, если решите изменять что-то в node_files/.

Изменять порт, который слушает эллиптикс нельзя, потому что это захардкожено в скрипте.